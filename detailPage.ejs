<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="keywords" content="">
    <meta name="description" content="">
    <meta name="author" content="Ansonika">
    <title>Eventure</title>

    <!-- Favicons-->
    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" type="image/x-icon" href="img/apple-touch-icon-57x57-precomposed.png">
    <link rel="apple-touch-icon" type="image/x-icon" sizes="72x72" href="img/apple-touch-icon-72x72-precomposed.png">
    <link rel="apple-touch-icon" type="image/x-icon" sizes="114x114" href="img/apple-touch-icon-114x114-precomposed.png">
    <link rel="apple-touch-icon" type="image/x-icon" sizes="144x144" href="img/apple-touch-icon-144x144-precomposed.png">

    <!-- GOOGLE WEB FONT -->
    <link href="https://fonts.googleapis.com/css2?family=Gochi+Hand&family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">

    <!-- BASE CSS -->
    <link href="css/animate.min.css" rel="stylesheet">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/menu.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/responsive.css" rel="stylesheet">
    <link href="css/elegant_font/elegant_font.min.css" rel="stylesheet">
    <link href="css/fontello/css/fontello.min.css" rel="stylesheet">
    <link href="css/magnific-popup.css" rel="stylesheet">
    <link href="css/pop_up.css" rel="stylesheet">


    <!-- Radio and check inputs -->
    <link href="css/skins/square/grey.css" rel="stylesheet">

    <!-- YOUR CUSTOM CSS -->
    <link href="css/custom.css" rel="stylesheet">

</head>

<body>

	<div id="preloader">
        <div class="sk-spinner sk-spinner-wave" id="status">
            <div class="sk-rect1"></div>
            <div class="sk-rect2"></div>
            <div class="sk-rect3"></div>
            <div class="sk-rect4"></div>
            <div class="sk-rect5"></div>
        </div>
    </div><!-- End Preload -->

    <!-- Header ================================================== -->
    <%- include("headerCustomer") %>
    <!-- End Header =============================================== -->

    <!-- SubHeader =============================================== -->
    <section class="parallax-window" id="short1" data-parallax="scroll" data-image-src="img/receipe3.jpg" data-natural-width="1400" data-natural-height="470">
        <div id="subheader">
            <div id="sub_content">
                <div id="thumb"><img src="uploads/<%= result && result[0].photo %>" alt=""></div>
                <h1><%= result && result[0].event_name %></h1>
                <div><%= result && result[0].desc %> </div>
            </div><!-- End sub_content -->
        </div><!-- End subheader -->
    </section><!-- End section -->
    <!-- End SubHeader ============================================ -->

    <!-- SubHeader =============================================== -->
	<section class="parallax-window" style="display: none;" id="short2" data-parallax="scroll" data-image-src="img/event-4.jpg" data-natural-width="1400" data-natural-height="350">
	    <div id="subheader">
	        <div id="sub_content">
	            <h1>Place your order</h1>
	            <div class="bs-wizard row">
	                <div class="col-4 bs-wizard-step active">
	                    <div class="text-center bs-wizard-stepnum"><strong>1.</strong> Your Details</div>
	                    <div class="progress">
	                        <div class="progress-bar"></div>
	                    </div>
	                    <a href="javascript:void(0)" class="bs-wizard-dot"></a>
	                </div>
	                <div class="col-4 bs-wizard-step active">
	                    <div class="text-center bs-wizard-stepnum"><strong>2.</strong> Payment</div>
	                    <div class="progress">
	                        <div class="progress-bar"></div>
	                    </div>
	                    <a href="javascript:void(0)" class="bs-wizard-dot"></a>
	                </div>
	                <div class="col-4 bs-wizard-step disabled">
	                    <div class="text-center bs-wizard-stepnum"><strong>3.</strong> Finish!</div>
	                    <div class="progress">
	                        <div class="progress-bar"></div>
	                    </div>
	                    <a href="javascript:void(0)" class="bs-wizard-dot"></a>
	                </div>
	            </div><!-- End bs-wizard -->
	        </div><!-- End sub_content -->
	    </div><!-- End subheader -->
	</section><!-- End section -->
	<!-- End SubHeader ============================================ -->

    <div id="position">
        <div class="container">
            <ul>
                <li><a href="/">Home</a></li>
            </ul>
        </div>
    </div><!-- Position -->

    <!-- Content ================================================== -->
    <div class="container margin_60_35">
        <div class="row">
            <div class="col-lg-8" id="first">
                <div class="box_style_2" id="main_menu">
                    <h2 class="inner">Event Details</h2>
                    <!-- <h3 class="nomargin_top" id="starters">Starters</h3>
                    <p>
                        Te ferri iisque aliquando pro, posse nonumes efficiantur in cum. Sensibus reprimique eu pro. Fuisset mentitum deleniti sit ea.
                    </p> -->
                    <table class="table table-striped cart-list">
                        <thead>
                            <tr>
                                <th>
                                    State
                                </th>
                                <th>
                                    City
                                </th>
                                <th>
                                    Max Persons allowed
                                </th>
                                <th>
                                    Remaining Slots
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <%= result[0].state %>
                                </td>
                                <td>
                                    <%= result[0].city %>
                                </td>
                                <td>
                                    <%= result[0].max_persons %>
                                </td>
                                <td>
                                    <%= result[0].remaining_persons %>
                                </td>
                            </tr>
                        </tbody>
                        <thead>
                            <tr>
                                <th>
                                    Date
                                </th>
                                <th>
                                    Time
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <%= result[0].date1 %>
                                </td>
                                <td>
                                    <%= result[0].time1 %>
                                </td>
                            </tr>
                        </tbody>
                        <thead>
                            <tr>
                                <th>
                                    Address
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="demo">
                                    <%= result[0].address %>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <hr>
                </div><!-- End box_style_1 -->
            </div><!-- End col -->
            <div class="col-lg-8" id="sec" style="display: none;">
	            <div class="box_style_2" id="order_process">
	                <h2 class="inner">Your order details</h2>
                    <form id="detail_form" name="detail_form">
	                <div class="form-group">
	                    <label>First name</label>
	                    <input type="text" class="form-control" id="firstname_order" name="fname" value="<%= customer[0].fname %>" placeholder="First name" required>
	                </div>
	                <div class="form-group">
	                    <label>Last name</label>
	                    <input type="text" class="form-control" id="lastname_order" name="lname" value="<%= customer[0].lname %>" placeholder="Last name" required>
	                </div>
	                <div class="form-group">
	                    <label>Mobile</label>
	                    <input type="text" id="tel_order" name="phone" value="<%= customer[0].phone %>" class="form-control" placeholder="Mobile" required>
	                </div>
	                <div class="form-group">
	                    <label>Email</label>
	                    <input type="email" id="email_booking_2" name="email" value="<%= customer[0].email %>" class="form-control" placeholder="Your email" required>
	                </div>
	                <div class="form-group">
	                    <label>Your full address</label>
	                    <input type="text" id="address_order" name="address" value="<%= customer[0].address %>" class="form-control" placeholder="Your full address" required>
	                </div>
	                <div class="row">
	                    <div class="col-md-6 col-sm-6">
	                        <div class="form-group">
	                            <label>City</label>
	                            <input type="text" id="city_order" name="city" value="<%= customer[0].city %>" class="form-control" placeholder="Your city" required>
	                        </div>
	                    </div>
	                    <div class="col-md-6 col-sm-6">
	                        <div class="form-group">
	                            <label>Postal code</label>
	                            <input type="text" id="pcode_oder" name="postal_code" value="<%= customer[0].postal_code %>" class="form-control" placeholder="Your postal code" required>
                                <input type="hidden" id="event_name" name="event_name" value="<%= result[0].event_name %>" />
                                <input type="hidden" id="event_id" name="event_id" value="<%= result[0].id %>" />
                                <input type="hidden" id="price" name="price" />
                                <input type="hidden" id="no_of_persons" name="no_of_persons" value="1" />
                                <input type="hidden" id="remaining_persons" name="remaining_persons" value="<%= result[0].remaining_persons %>" />
	                        </div>
	                    </div>
	                </div>
                    </form>
	            </div><!-- End box_style_1 -->
	        </div><!-- End col -->

            <div class="col-lg-8" id="third" style="display: none;">
                <div class="box_style_2">
                    <h2 class="inner">Payment methods</h2>
                    <div class="payment_select">
                        <label>
                            <div class="iradio_square-grey" style="position: relative;">
                                <input type="radio" value="credit_card" checked name="payment_method" class="icheck" style="position: absolute; opacity: 0;">
                                <ins class="iCheck-helper" style="position: absolute; top: 0%; left: 0%; display: block; width: 100%; height: 100%; margin: 0px; padding: 0px; background: rgb(255, 255, 255); border: 0px; opacity: 0;"></ins>
                            </div>Credit card
                        </label>
                        <i class="icon_creditcard"></i>
                    </div>
                    <div class="payment_select">
                        <label>
                            <div class="iradio_square-grey" style="position: relative;">
                                <input type="radio" value="debit_card" name="payment_method" class="icheck" style="position: absolute; opacity: 0;">
                                <ins class="iCheck-helper" style="position: absolute; top: 0%; left: 0%; display: block; width: 100%; height: 100%; margin: 0px; padding: 0px; background: rgb(255, 255, 255); border: 0px; opacity: 0;"></ins>
                            </div>Debit card
                        </label>
                        <i class="icon_creditcard"></i>
                    </div>

                    <a href="./qr.ejs"> UPI/QR code </a></li>
                    
                    <form id="payment_form" name="payment_form">
                        <div class="form-group">
                            <label for="name_card_order">Name on Card</label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="name_card_order" 
                                name="name_card_order" 
                                placeholder="First and Last Name"
                                pattern="[A-Za-z\s]{1,50}" 
                                required>
                            <small>Enter name exactly as it appears on your card.</small>
                        </div>
                        <div class="form-group">
                            <label for="card_number">Card Number</label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="card_number" 
                                name="card_number" 
                                placeholder="1234 5678 9012 3456"
                                maxlength="19" 
                                inputmode="numeric"
                                pattern="\d{13,19}" 
                                required>
                            <small>Enter 13-19 digit card number.</small>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label>Expiration date</label>
                                <div class="row">
                                    <div class="col-md-6 col-sm-6">
                                        <div class="form-group">
                                            <label for="expire_month">Expiry Month (MM)</label>
                                            <input 
                                                type="number" 
                                                class="form-control" 
                                                id="expire_month" 
                                                name="expire_month" 
                                                placeholder="MM"
                                                min="1" 
                                                max="12" 
                                                required>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-sm-6">
                                        <div class="form-group">
                                            <label for="expire_year">Expiry Year (YYYY)</label>
                                            <input 
                                                type="number" 
                                                class="form-control" 
                                                id="expire_year" 
                                                name="expire_year" 
                                                placeholder="YYYY"
                                                min="2024" 
                                                required>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-sm-12">
                                <div class="form-group">
                                    <label>Security code</label>
                                    <div class="row">
                                        <div class="col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="ccv">CCV</label>
                                                <input 
                                                    type="text" 
                                                    class="form-control" 
                                                    id="ccv" 
                                                    name="ccv" 
                                                    placeholder="123"
                                                    maxlength="4" 
                                                    pattern="\d{3,4}" 
                                                    inputmode="numeric" 
                                                    required>
                                                <small>3-4 digit security code.</small>
                                            </div>
                                        </div>
                                        <div class="col-md-8 col-sm-6">
                                            <img src="img/icon_ccv.gif" width="50" height="29" alt="ccv"><small>Last 3 digits</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!--End row -->
                    </form>
                </div><!-- End box_style_1 -->
            </div>

            <div class="col-lg-3" id="sidebar">
                <div class="theiaStickySidebar">
                    <div id="cart_box">
                        <h3>Your order <i class="icon_cart_alt float-right"></i></h3>
                        <table class="table table_summary" id="my_table">
                            <tbody id="carto">
                                
                            </tbody>
                        </table>
                        <hr>
                        <table class="table table_summary">
                            <tbody>
                                <tr>
                                    <td>
                                        Subtotal <span class="float-right" id="st"> Rs 0</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        Platform fee <span class="float-right">Rs 10</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="total">
                                        TOTAL <span class="float-right"  id="tt"></span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <hr>
                        <a class="btn_full" href="javascript:void(0)" onclick="change()">Order now</a>
                    </div><!-- End cart_box -->
                </div><!-- End theiaStickySidebar -->
            </div><!-- End col -->
        </div><!-- End row -->
    </div><!-- End container -->
    <!-- End Content =============================================== -->

    <!-- Footer ================================================== -->
    <%- include("footer") %>
    <!-- End Footer =============================================== -->

<!-- COMMON SCRIPTS -->
<script src="js/jquery-3.5.1.min.js"></script>
<script src="js/common_scripts_min.js"></script>
<script src="js/functions.js"></script>

<!-- SPECIFIC SCRIPTS -->
<script  src="js/cat_nav_mobile.js"></script>
<script>$('#cat_nav').mobileMenu();</script>
<script src="js/ResizeSensor.min.js"></script>
<script src="js/theia-sticky-sidebar.min.js"></script>
<script>
    jQuery('#sidebar').theiaStickySidebar({
      additionalMarginTop: 80
    });
</script>
<!-- SMOOTH SCROLL -->
<script>
	$('#cat_nav a[href^="#"]').click(function() {
        if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'')
			|| location.hostname == this.hostname) {
			var target = $(this.hash);
        	target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
			   if (target.length) {
				 $('html,body').animate({
					 scrollTop: target.offset().top -75
				}, 800);
				return false;
			}
		}
	});
</script>
<script>
    let subtotal=0;
    let total=0;
    addtocart('<%= result[0].event_name%>', '<%= result[0].ticket_price%>');
    function addtocart(event_name, price){
            let demo = $(".demo").html().replace(/\r?\n/g, '<br />');
            $(".demo").html(demo);
            let num=parseInt(price);
            subtotal+=num;
            total=subtotal+10;
            $('#st').html("Rs "+subtotal);
            $('#tt').html("Rs "+total);
            $('#price').val(total);
            $('#my_table > tbody:last-child').append(`<tr><td><a href="javascript:void(0)" attr="`+price+`" class="remove_item"><i class="icon_minus_alt"></i></a><input type="text" class="input_count" id="input_count" readonly name="name" value="1"><a href="javascript:void(0)" attr="`+price+`" class="add_item"><i class="icon_plus_alt"></i></a><strong> `+event_name+`</strong></td><td><strong class="float-right">Rs `+price+`</strong></td></tr>`);
    }
    $('#my_table > tbody:last-child').on('click', '.remove_item', function(e) {
        e.preventDefault();
        let price = parseInt($(this)[0].attributes.attr.value);
        let value = parseInt($("#input_count").val());
        if(value > 1) {
            value = value-1;
            total = total-price;
            subtotal = subtotal-price;
            $('#st').html("Rs "+subtotal);
            $('#tt').html("Rs "+total);
            $('#price').val(total);
            $('#no_of_persons').val(value);
            $("#input_count").val(value);
        }
    });
    $('#my_table > tbody:last-child').on('click', '.add_item', function(e) {
        e.preventDefault();
        let price = parseInt($(this)[0].attributes.attr.value);
        let value = parseInt($("#input_count").val());
        let remaining_persons = parseInt($("#remaining_persons").val());
        if(remaining_persons > value) {
            value = value+1;
            total = total+price;
            subtotal = subtotal+price;
            $('#st').html("Rs "+subtotal);
            $('#tt').html("Rs "+total);
            $('#price').val(total);
            $('#no_of_persons').val(value);
            $("#input_count").val(value);
        } else {
            alert('We have remaining slots only - '+remaining_persons);
        }
    });
    // document.querySelectorAll('.icheck').forEach((radio) => {
    //     radio.addEventListener('change', function () {
    //         // Remove the 'checked' class from all .iradio_square-grey divs
    //         document.querySelectorAll('.iradio_square-grey').forEach((el) => el.classList.remove('checked'));
            
    //         // Add the 'checked' class to the parent div of the selected radio button
    //         if (this.checked) {
    //             this.parentElement.classList.add('checked');
    //         }
    //     });
    // });
    
    document.addEventListener('DOMContentLoaded', () => {
        // Ensure the default checked radio button has the 'checked' class
        const defaultRadio = document.querySelector('.icheck[name="payment_method"]:checked');
        if (defaultRadio) {
            defaultRadio.parentElement.classList.add('checked');
        }

        // Add change event to all radio buttons
        document.querySelectorAll('.icheck').forEach((radio) => {
            radio.addEventListener('change', function () {
                // Remove the 'checked' class from all radio buttons' parent divs
                document.querySelectorAll('.iradio_square-grey').forEach((el) => el.classList.remove('checked'));

                // Add the 'checked' class to the parent div of the currently selected radio button
                if (this.checked) {
                    this.parentElement.classList.add('checked');
                }
            });
        });
    });

    

    document.getElementById('card_number').addEventListener('input', function (e) {
        let value = e.target.value.replace(/\s+/g, ''); // Remove spaces
        if (/^\d+$/.test(value) && value.length <= 19) {
            e.target.value = value.replace(/(\d{4})/g, '$1 ').trim(); // Add space every 4 digits
        } else {
            e.target.value = e.target.value.slice(0, -1); // Prevent invalid characters
        }
    });

    function validateForm() {
        if (document.forms["detail_form"]["fname"].value == "") {
            alert("First Name is required");
            return false;
        }
        else if (document.forms["detail_form"]["lname"].value == "") {
            alert("Last Name is required");
            return false;
        }
        else if (document.forms["detail_form"]["phone"].value == "") {
            alert("Mobile is required");
            return false;
        }
        else if (document.forms["detail_form"]["email"].value == "") {
            alert("Email is required");
            return false;
        }
        else if (document.forms["detail_form"]["address"].value == "") {
            alert("Address is required");
            return false;
        }
        else if (document.forms["detail_form"]["city"].value == "") {
            alert("City is required");
            return false;
        }
        else if (document.forms["detail_form"]["postal_code"].value == "") {
            alert("Postal Code is required");
            return false;
        }
        return true;
    }
    function validatePaymentForm() {
        const nameOnCard = document.forms["payment_form"]["name_card_order"].value.trim();
        const expireMonth = document.forms["payment_form"]["expire_month"].value.trim();
        const expireYear = document.forms["payment_form"]["expire_year"].value.trim();
        const ccv = document.forms["payment_form"]["ccv"].value.trim();

        // Validate Name on Card
        if (nameOnCard === "") {
            alert("Name on Card is required");
            return false;
        }
        // Validate Card Number using Luhn Algorithm
        const cardNumber = document.getElementById('card_number').value.replace(/\s+/g, '');
        if (!validateCardNumber(cardNumber)) {
            alert('Invalid card number!');
            return false;
        }
        // Validate Expiration Date
        if (!validateExpirationDate(expireMonth, expireYear)) {
            alert("Invalid Expiration Date");
            return false;
        }
        // Validate CCV
        if (!/^\d{3,4}$/.test(ccv)) {
            alert("Invalid CCV");
            return false;
        }
        return true; // Allow form submission
    }

    function validateCardNumber(cardNumber) {
        let sum = 0, shouldDouble = false;
        for (let i = cardNumber.length - 1; i >= 0; i--) {
            let digit = parseInt(cardNumber.charAt(i));
            if (shouldDouble) {
                digit *= 2;
                if (digit > 9) digit -= 9;
            }
            sum += digit;
            shouldDouble = !shouldDouble;
        }
        return sum % 10 === 0;
    }

    // Helper function to validate expiration date
    function validateExpirationDate(month, year) {
        const currentYear = new Date().getFullYear();
        const currentMonth = new Date().getMonth() + 1;
        if (!/^\d{1,2}$/.test(month) || !/^\d{4}$/.test(year)) return false; // Check format
        const expMonth = parseInt(month);
        const expYear = parseInt(year);
        if (expMonth < 1 || expMonth > 12 || expYear < currentYear) return false; // Check valid range
        if (expYear === currentYear && expMonth < currentMonth) return false; // Check if expired
        return true;
    }

    let flag=0;
    function change(){
        if(flag===0){
            $('#first').hide();
            $('#short1').hide();
            $('#sec').show();
            $('#short2').show();
            flag=1;
        } else if(flag===1){
            if(validateForm()){
                $('#first').hide();
                $('#short1').hide();
                $('#sec').hide();
                $('#third').show();
                $('#short2').show();
                // $('#detail_form').submit();
                flag=2;
            }
        } else {
            if(validatePaymentForm()){
                const detailForm = document.getElementById('detail_form');
                const detailData = new FormData(detailForm);

                // Collect data from payment_form
                const paymentForm = document.getElementById('payment_form');
                const paymentData = new FormData(paymentForm);

                // Merge detail_form and payment_form data
                for (let [key, value] of detailData.entries()) {
                    paymentData.append(key, value);
                }

                // Convert FormData to a JSON object
                const jsonData = {};
                for (let [key, value] of paymentData.entries()) {
                    jsonData[key] = value;
                }
                console.log('jsonData: ', JSON.stringify(jsonData));
                fetch("thankyou", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(jsonData),
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.text(); // Get the response as plain text (HTML content)
                })
                .then(html => {
                    // Inject the EJS-rendered HTML into a specific element or replace the entire page
                    document.open(); // Open a new document context
                    document.write(html); // Replace current content with the fetched HTML
                    document.close(); // Close the document context
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("An error occurred while processing the payment.");
                });
            }
        }
    }
</script>
</body>
</html>
